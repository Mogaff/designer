<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Ads Scraper Diagnostic Viewer</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f9f9f9;
    }
    .header {
      background-color: #1a73e8;
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    h1 {
      margin: 0;
      font-size: 24px;
    }
    .container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .screenshots {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .screenshot {
      background-color: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .screenshot:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .screenshot-image {
      max-width: 100%;
      height: auto;
      cursor: pointer;
    }
    .screenshot-title {
      padding: 10px;
      font-weight: 600;
      background-color: #f1f3f4;
      border-bottom: 1px solid #e0e0e0;
    }
    .screenshot-timestamp {
      padding: 5px 10px;
      font-size: 12px;
      color: #666;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.8);
      z-index: 100;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .modal-content {
      max-width: 90%;
      max-height: 90vh;
      background-color: white;
      border-radius: 8px;
      overflow: auto;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }
    .modal-image {
      max-width: 100%;
      height: auto;
    }
    .close-modal {
      position: absolute;
      top: 20px;
      right: 20px;
      color: white;
      font-size: 30px;
      cursor: pointer;
    }
    .diagnostic-info {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .diagnostic-info table {
      width: 100%;
      border-collapse: collapse;
    }
    .diagnostic-info table th,
    .diagnostic-info table td {
      padding: 8px 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    .diagnostic-info table th {
      background-color: #f1f3f4;
    }
    .actions {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
    button {
      background-color: #1a73e8;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #0d62d1;
    }
    .html-content {
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 12px;
      overflow: auto;
      max-height: 300px;
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #e0e0e0;
    }
    .warning {
      background-color: #fff3cd;
      color: #856404;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Google Ads Scraper Diagnostic Viewer</h1>
    <p>View and analyze screenshots and diagnostic information from the Google Ads scraper</p>
  </div>

  <div class="container">
    <div class="diagnostic-info">
      <h2>Diagnostic Information</h2>
      <div id="diagnosticData">
        <p>No diagnostic data available. Run a diagnostic test first.</p>
        <div class="actions">
          <button id="runDiagnostic">Run Diagnostic Test</button>
          <button id="refreshData">Refresh Data</button>
        </div>
      </div>
    </div>

    <div class="screenshots">
      <h2>Screenshots</h2>
      <div id="screenshotContainer">
        <p>No screenshots available.</p>
      </div>
    </div>

    <div class="html-viewer">
      <h2>HTML Content Preview</h2>
      <div id="htmlContent" class="html-content">
        <p>No HTML content available.</p>
      </div>
    </div>
  </div>

  <div class="modal" id="screenshotModal">
    <span class="close-modal" id="closeModal">&times;</span>
    <div class="modal-content">
      <img src="" alt="Screenshot" class="modal-image" id="modalImage">
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('screenshotModal');
      const modalImage = document.getElementById('modalImage');
      const closeModal = document.getElementById('closeModal');
      const runDiagnosticBtn = document.getElementById('runDiagnostic');
      const refreshDataBtn = document.getElementById('refreshData');
      const screenshotContainer = document.getElementById('screenshotContainer');
      const diagnosticDataContainer = document.getElementById('diagnosticData');
      const htmlContentContainer = document.getElementById('htmlContent');

      // Close modal when clicking the close button
      closeModal.addEventListener('click', function() {
        modal.style.display = 'none';
      });

      // Close modal when clicking outside the image
      modal.addEventListener('click', function(event) {
        if (event.target === modal) {
          modal.style.display = 'none';
        }
      });

      // Run diagnostic test
      runDiagnosticBtn.addEventListener('click', function() {
        runDiagnostic();
      });

      // Refresh data
      refreshDataBtn.addEventListener('click', function() {
        loadData();
      });

      // Function to open modal with larger image
      function openModal(imageUrl) {
        modalImage.src = imageUrl;
        modal.style.display = 'flex';
      }

      // Function to load screenshots
      function loadScreenshots() {
        fetch('/temp')
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to load temp directory');
            }
            return response.json();
          })
          .then(data => {
            if (data.files && data.files.length > 0) {
              const screenshots = data.files.filter(file => file.endsWith('.png'));
              
              if (screenshots.length > 0) {
                screenshotContainer.innerHTML = '';
                
                screenshots.forEach(file => {
                  const screenshot = document.createElement('div');
                  screenshot.className = 'screenshot';
                  
                  const title = document.createElement('div');
                  title.className = 'screenshot-title';
                  title.textContent = file;
                  
                  const img = document.createElement('img');
                  img.className = 'screenshot-image';
                  img.src = `/temp/${file}`;
                  img.alt = file;
                  img.addEventListener('click', function() {
                    openModal(`/temp/${file}`);
                  });
                  
                  screenshot.appendChild(title);
                  screenshot.appendChild(img);
                  screenshotContainer.appendChild(screenshot);
                });
              } else {
                screenshotContainer.innerHTML = '<p>No screenshots available.</p>';
              }
            } else {
              screenshotContainer.innerHTML = '<p>No screenshots available.</p>';
            }
          })
          .catch(error => {
            console.error('Error loading screenshots:', error);
            screenshotContainer.innerHTML = '<p>Error loading screenshots: ' + error.message + '</p>';
          });
      }

      // Function to load HTML content
      function loadHtmlContent() {
        fetch('/temp/google-ads-page-source.txt')
          .then(response => {
            if (!response.ok) {
              throw new Error('HTML content not available');
            }
            return response.text();
          })
          .then(html => {
            // Find first 1000 characters for preview
            const preview = html.substring(0, 1000) + '...';
            htmlContentContainer.textContent = preview;
            
            // Look for indicators of issues
            let warnings = [];
            if (html.includes('captcha') || html.includes('CAPTCHA')) {
              warnings.push('CAPTCHA detected on page');
            }
            if (html.includes('unusual activity') || html.includes('suspicious')) {
              warnings.push('Security warning detected on page');
            }
            if (html.includes('blocked') || html.includes('limit') || html.includes('too many requests')) {
              warnings.push('Possible rate limiting or blocking detected');
            }
            
            if (warnings.length > 0) {
              const warningElem = document.createElement('div');
              warningElem.className = 'warning';
              warningElem.innerHTML = '<strong>Warnings detected:</strong><ul>' + 
                warnings.map(w => `<li>${w}</li>`).join('') + '</ul>';
              htmlContentContainer.appendChild(warningElem);
            }
          })
          .catch(error => {
            console.log('HTML content not available:', error);
            htmlContentContainer.textContent = 'No HTML content available.';
          });
      }

      // Function to load diagnostic data
      function loadDiagnosticData() {
        fetch('/api/ad-inspiration/diagnostic/google')
          .then(response => response.json())
          .then(data => {
            let html = '<table>';
            html += '<tr><th>Attribute</th><th>Value</th></tr>';
            html += `<tr><td>Success</td><td>${data.success ? '✅ Yes' : '❌ No'}</td></tr>`;
            html += `<tr><td>Advertiser</td><td>${data.query.advertiser}</td></tr>`;
            html += `<tr><td>Region</td><td>${data.query.region}</td></tr>`;
            html += `<tr><td>Duration</td><td>${data.duration.toFixed(2)} seconds</td></tr>`;
            html += `<tr><td>Ads found</td><td>${data.adCount}</td></tr>`;
            html += `<tr><td>Google URL</td><td><a href="${data.googleUrl}" target="_blank">${data.googleUrl}</a></td></tr>`;
            html += `<tr><td>Screenshots</td><td>${data.screenshots ? data.screenshots.length : 0}</td></tr>`;
            html += `<tr><td>Timestamp</td><td>${new Date(data.timeStamp).toLocaleString()}</td></tr>`;
            html += '</table>';
            
            if (data.message) {
              html += `<div class="${data.success ? 'success' : 'warning'}">${data.message}</div>`;
            }
            
            diagnosticDataContainer.innerHTML = html;
            
            // Add action buttons back
            const actions = document.createElement('div');
            actions.className = 'actions';
            actions.innerHTML = `
              <button id="runDiagnostic">Run Diagnostic Test</button>
              <button id="refreshData">Refresh Data</button>
            `;
            diagnosticDataContainer.appendChild(actions);
            
            // Re-add event listeners
            document.getElementById('runDiagnostic').addEventListener('click', runDiagnostic);
            document.getElementById('refreshData').addEventListener('click', loadData);
          })
          .catch(error => {
            console.error('Error loading diagnostic data:', error);
            diagnosticDataContainer.innerHTML = `
              <p>Error loading diagnostic data: ${error.message}</p>
              <div class="actions">
                <button id="runDiagnostic">Run Diagnostic Test</button>
                <button id="refreshData">Refresh Data</button>
              </div>
            `;
            
            // Re-add event listeners
            document.getElementById('runDiagnostic').addEventListener('click', runDiagnostic);
            document.getElementById('refreshData').addEventListener('click', loadData);
          });
      }

      // Function to run diagnostic test
      function runDiagnostic() {
        diagnosticDataContainer.innerHTML = '<p>Running diagnostic test... This may take 30-45 seconds.</p>';
        
        // Get parameters
        const advertiser = prompt('Enter advertiser ID or brand name (default: AR18054737239162880)', 'AR18054737239162880');
        if (!advertiser) return;
        
        const region = prompt('Enter region code (default: US)', 'US');
        const maxAds = prompt('Enter maximum number of ads to retrieve (default: 3)', '3');
        const timeout = prompt('Enter timeout in milliseconds (default: 45000)', '45000');
        
        // Build URL with parameters
        let url = `/api/ad-inspiration/diagnostic/google?advertiser=${advertiser}`;
        if (region) url += `&region=${region}`;
        if (maxAds) url += `&maxAds=${maxAds}`;
        if (timeout) url += `&timeout=${timeout}`;
        
        fetch(url)
          .then(response => response.json())
          .then(() => {
            // After completion, load all data
            loadData();
          })
          .catch(error => {
            console.error('Error running diagnostic:', error);
            diagnosticDataContainer.innerHTML = `
              <p>Error running diagnostic: ${error.message}</p>
              <div class="actions">
                <button id="runDiagnostic">Run Diagnostic Test</button>
                <button id="refreshData">Refresh Data</button>
              </div>
            `;
            
            // Re-add event listeners
            document.getElementById('runDiagnostic').addEventListener('click', runDiagnostic);
            document.getElementById('refreshData').addEventListener('click', loadData);
          });
      }

      // Function to load all data
      function loadData() {
        loadScreenshots();
        loadHtmlContent();
        loadDiagnosticData();
      }

      // Initial load
      loadData();
    });
  </script>
</body>
</html>